version: "3.9"

services:
  db:
    image: postgres:16
    container_name: paylabs_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  adminer:
    image: adminer:4
    container_name: paylabs_adminer
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "${ADMINER_PORT}:8080"

  mcp-server:
    build:
      context: ./mcp-server
      dockerfile: Dockerfile
    container_name: paylabs_mcp_server
    restart: unless-stopped
    depends_on:
      - db
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB}
      DB_READ_USER: ${DB_READ_USER}
      DB_READ_PASSWORD: ${DB_READ_PASSWORD}
      DB_WRITE_USER: ${DB_WRITE_USER}
      DB_WRITE_PASSWORD: ${DB_WRITE_PASSWORD}
      FASTMCP_HOST: 0.0.0.0
      FASTMCP_PORT: 5001
      ACTIVE_REPORT_ID: ${ACTIVE_REPORT_ID}
    ports:
      - "${MCP_PORT}:5001"

  agent:
    build:
      context: .
      dockerfile: agent/Dockerfile
    container_name: paylabs_agent
    restart: unless-stopped
    depends_on:
      - mcp-server
    environment:
      MCP_URL: http://mcp-server:5001/mcp
      SKILL_PATH: /app/skills/analytic-reporting/SKILL.md
      AGENT_LLM: ${AGENT_LLM}
      AGENT_BASE_URL: ${AGENT_BASE_URL}
      AGENT_MODEL: ${AGENT_MODEL}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL}
      OPENAI_MODEL: ${OPENAI_MODEL}
    ports:
      - "${AGENT_PORT}:8000"

volumes:
  pgdata:
